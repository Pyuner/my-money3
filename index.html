<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>–î–æ–º–∞—à–Ω—è—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
 :root{
   --accent:#007bff;
   --bg:#f7f7f7;
   --card:#fff;
   --text:#333;
   --border:#e0e0e0;
   --success:#28a745;
   --warning:#ffc107;
   --danger:#dc3545;
 }
 [data-theme="dark"]{
   --bg:#121212;
   --card:#1e1e1e;
   --text:#eee;
   --border:#444;
 }
 *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
 body{background:var(--bg);color:var(--text);transition:.2s}
 nav,.sub{display:flex;background:var(--card);border-bottom:1px solid var(--border)}
 nav button,.sub button{flex:1;padding:14px;border:none;background:none;cursor:pointer;font-weight:600}
 nav button.active,.sub button.active{color:var(--accent);border-bottom:2px solid var(--accent)}
 main{padding:20px;max-width:800px;margin:auto}
 section{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px;margin-bottom:20px}
 form{display:grid;gap:12px}
 input,select,button{padding:8px 10px;border:1px solid var(--border);border-radius:4px;font-size:1rem}
 button[type=submit]{background:var(--accent);color:#fff;cursor:pointer}
 ul{list-style:none}li{padding:6px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
 canvas{width:100%!important;height:300px!important}
 .filter-bar{display:flex;gap:8px;margin-bottom:10px}
 .filter-bar button{padding:4px 8px;font-size:.8rem;border:1px solid var(--border);border-radius:4px;background:#fff}
 [data-theme="dark"] .filter-bar button{background:#222}
 .search-box{margin-bottom:10px}
 .tag-red{background:var(--danger);color:#fff;padding:2px 6px;border-radius:4px;font-size:.7rem}
 .tag-yellow{background:var(--warning);color:#000;padding:2px 6px;border-radius:4px;font-size:.7rem}
 .tag-green{background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:.7rem}
 .theme-btn{margin-left:auto;background:none;border:none;font-size:1.2rem;cursor:pointer}
 .cloud-btn{margin-left:8px}
</style>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>

<nav>
  <button type="button" data-tab="home" class="active">–ì–ª–∞–≤–Ω–∞—è</button>
  <button type="button" data-tab="expenses">–†–∞—Å—Ö–æ–¥—ã</button>
  <button type="button" data-tab="incomes">–î–æ—Ö–æ–¥—ã</button>
  <button type="button" data-tab="work">–†–∞–±–æ—Ç–∞</button>

  <!-- ‚úÖ –∫–Ω–æ–ø–∫–∏ –±–µ–∑ onclick -->
  <span>
    <button type="button" id="loginBtn">–í–æ–π—Ç–∏</button>
    <button type="button" id="registerBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <span id="userInfo" style="display:none">
      <button type="button" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </span>
  </span>
</nav>
 
<main id="content"></main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script type="module">

/* === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ === */
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginBtn').addEventListener('click', loginForm);
  document.getElementById('registerBtn').addEventListener('click', registerForm);
  document.getElementById('logoutBtn').addEventListener('click', logout);
});
 
/* ==========================================================
   0.  GLOBAL VARS
========================================================== */
let hasSub = false;
let currentUser = null;

/* ==========================================================
   1.  FIREBASE CONFIG  (PUT YOUR OWN!)
========================================================== */
const firebaseConfig = {
  apiKey: "AIzaSyAVHxqN7PNgZRpon88Wa_UrF2D2UXufj0Y",
  authDomain: "JobCount.firebaseapp.com",
  projectId: "JobCount-17cd5",
  storageBucket: "JobCount.appspot.com",
  messagingSenderId: "322280447472",
  appId: "1:123:web:abc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

/* ==========================================================
   2.  SUBSCRIPTION CHECK
========================================================== */
async function checkSubscription() {
  if (!currentUser) return;
  const snap = await db.collection('users').doc(currentUser.uid).get();
  const data = snap.data();
  const sub = data?.sub_until?.toDate();
  hasSub = sub && sub > new Date();
  if (!hasSub) {
    alert("–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç.");
  }
}

/* ==========================================================
   3.  AUTH UI HELPERS
========================================================== */
function loginForm() {
  document.getElementById('authTitle').textContent = '–í—Ö–æ–¥';
  document.getElementById('name').style.display = 'none';
  document.getElementById('authModal').style.display = 'block';
  mode = 'login';
}
function registerForm() {
  document.getElementById('authTitle').textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
  document.getElementById('name').style.display = 'inline';
  document.getElementById('authModal').style.display = 'block';
  mode = 'register';
}
function closeAuth() {
  document.getElementById('authModal').style.display = 'none';
}
let mode = 'login';
async function submitAuth() {
  const email = document.getElementById('email').value;
  const pwd = document.getElementById('password').value;
  const name = document.getElementById('name').value;
  try {
    if (mode === 'login') {
      await auth.signInWithEmailAndPassword(email, pwd);
    } else {
      await auth.createUserWithEmailAndPassword(email, pwd);
      await db.collection('users').doc(auth.currentUser.uid).set({
        name,
        email,
        reg_date: new Date(),
        sub_until: null,
        first_sub: null,
        sub_buys: 0
      });
    }
    closeAuth();
  } catch (e) {
    alert(e.message);
  }
}
function logout() {
  auth.signOut();
}

/* ==========================================================
   4.  INDEXEDDB HELPERS
========================================================== */
const DB_NAME = 'finance', DB_VER = 2;
function openDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open(DB_NAME, DB_VER);
    r.onerror = () => rej(r.error);
    r.onsuccess = () => res(r.result);
    r.onupgradeneeded = () => {
      const db = r.result;
      ['expenses', 'incomes', 'positions', 'worklog'].forEach(s => {
        if (!db.objectStoreNames.contains(s))
          db.createObjectStore(s, { keyPath: 'id', autoIncrement: true });
      });
    };
  });
}
async function add(store, o) {
  if (!hasSub) { alert('–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.'); return; }
  o.owner = currentUser?.uid || null;
  const db = await openDB();
  return new Promise((res, rej) => {
    const q = db.transaction(store, 'readwrite').objectStore(store).add(o);
    q.onsuccess = () => res(q.result);
    q.onerror = () => rej(q.error);
  });
}
async function put(store, o) {
  if (!hasSub) { alert('–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.'); return; }
  o.owner = currentUser?.uid || null;
  const db = await openDB();
  return new Promise((res, rej) => {
    const q = db.transaction(store, 'readwrite').objectStore(store).put(o);
    q.onsuccess = () => res(q.result);
    q.onerror = () => rej(q.error);
  });
}
async function getAll(store) {
  const db = await openDB();
  return new Promise((res, rej) => {
    const q = db.transaction(store, 'readonly').objectStore(store).getAll();
    q.onsuccess = () => res(q.result);
    q.onerror = () => rej(q.error);
  });
}
async function del(store, id) {
  if (!hasSub) { alert('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞.'); return; }
  const db = await openDB();
  return new Promise((res, rej) => {
    const q = db.transaction(store, 'readwrite').objectStore(store).delete(id);
    q.onsuccess = res;
    q.onerror = () => rej(q.error);
  });
}

/* ==========================================================
   5.  CHART.JS HELPERS
========================================================== */
import Chart from 'https://cdn.jsdelivr.net/npm/chart.js@4/auto/+esm';
function pie(ctx, lbl, data) {
  new Chart(ctx, {
    type: 'pie',
    data: { labels: lbl, datasets: [{ data, backgroundColor: ['#28a745', '#dc3545'] }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}
function bar(ctx, lbl, data) {
  new Chart(ctx, {
    type: 'bar',
    data: { labels: lbl, datasets: [{ label: '‚ÇΩ', data, backgroundColor: '#007bff' }] },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

/* ==========================================================
   6.  THEME TOGGLE
========================================================== */
const themeToggle = document.getElementById('themeToggle');
if (themeToggle) {
  themeToggle.addEventListener('click', () => {
    const dark = document.documentElement.dataset.theme === 'dark';
    document.documentElement.dataset.theme = dark ? 'light' : 'dark';
    themeToggle.textContent = dark ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', document.documentElement.dataset.theme);
  });
  document.documentElement.dataset.theme = localStorage.getItem('theme') || 'light';
  themeToggle.textContent = document.documentElement.dataset.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

/* ==========================================================
   7.  CLOUD SYNC BUTTON
========================================================== */
let syncEnabled = false;
const syncBtn = document.getElementById('syncToggle');
if (syncBtn) {
  syncBtn.addEventListener('click', async () => {
    syncEnabled = !syncEnabled;
    syncBtn.style.color = syncEnabled ? 'var(--accent)' : '';
    if (!syncEnabled) return;
    const tables = ['expenses', 'incomes', 'positions', 'worklog'];
    for (const t of tables) {
      const local = await getAll(t);
      for (const r of local) {
        await db.collection(t).doc(r.id.toString()).set({ ...r, owner: currentUser?.uid || null });
      }
    }
    alert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ!');
  });
}

/* ==========================================================
   8.  ROUTER & TAB RENDERING
========================================================== */
const nav = document.querySelector('nav');
const content = document.getElementById('content');
nav.addEventListener('click', e => {
  if (!e.target.dataset.tab) return;
  [...nav.children].forEach(b => b.classList.remove('active'));
  e.target.classList.add('active');
  render(e.target.dataset.tab);
});
window.render = function (tab) {
  tabs[tab](content);
};

/* ==========================================================
   9.  TAB DEFINITIONS
========================================================== */
const tabs = {
  async home(root) {
    const [inc, exp] = await Promise.all([getAll('incomes'), getAll('expenses')]);
    const incCats = {}, expCats = {};
    inc.forEach(r => incCats[r.category] = (incCats[r.category] || 0) + r.amount);
    exp.forEach(r => expCats[r.category] = (expCats[r.category] || 0) + r.amount);

    root.innerHTML = `
      <section><h2>–î–æ—Ö–æ–¥—ã / –†–∞—Å—Ö–æ–¥—ã</h2><canvas id="pie"></canvas></section>
      <section><h2>–î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
        <ul>${Object.entries(incCats).sort(([,a],[,b])=>b-a).map(([c,s])=>`<li><span class="tag-${rColor(c)}"></span>${c}: ${s.toFixed(2)}‚ÇΩ</li>`).join('')}</ul>
      </section>
      <section><h2>–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
        <ul>${Object.entries(expCats).sort(([,a],[,b])=>b-a).map(([c,s])=>`<li><span class="tag-${rColor(c)}"></span>${c}: ${s.toFixed(2)}‚ÇΩ</li>`).join('')}</ul>
      </section>

      <section>
        <h2>–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è –ø–æ –¥–Ω—è–º</h2>
        <canvas id="balanceChart"></canvas>
      </section>

      <section>
        <h2>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</h2>
        <div class="filter-bar">
          <button data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
          <button data-filter="week">–ù–µ–¥–µ–ª—è</button>
          <button data-filter="month">–ú–µ—Å—è—Ü</button>
        </div>
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="search-box">
        <ul id="homeList"></ul>
      </section>`;

    const totalInc = Object.values(incCats).reduce((a, b) => a + b, 0);
    const totalExp = Object.values(expCats).reduce((a, b) => a + b, 0);
    pie(document.getElementById('pie'), ['–î–æ—Ö–æ–¥—ã', '–†–∞—Å—Ö–æ–¥—ã'], [totalInc, totalExp]);
    drawBalanceChart(inc, exp);
    drawHomeList(inc.concat(exp.map(e => ({ ...e, type: 'expenses' }))));
  },

  async expenses(root) {
    root.innerHTML = `
      <section>
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h2>
        <form id="expForm">
          <input name="amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required>
          <input name="date" type="date" required>
          <input name="target" placeholder="–ö—É–¥–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ" required>
          <select name="category">
            <option value="–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã">–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã</option>
            <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
            <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
            <option value="–¢–∞–∫—Å–∏">–¢–∞–∫—Å–∏</option>
            <option value="–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã</option>
            <option value="–î–æ–ª–≥–∏">–î–æ–ª–≥–∏</option>
            <option value="custom">–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è‚Ä¶</option>
          </select>
          <input name="custom" placeholder="–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" style="display:none">
          <select name="color">
            <option value="green">üü¢</option>
            <option value="yellow">üü°</option>
            <option value="red">üî¥</option>
          </select>
          <button>–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
      </section>
      <section>
        <div class="filter-bar">
          <button data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
          <button data-filter="week">–ù–µ–¥–µ–ª—è</button>
          <button data-filter="month">–ú–µ—Å—è—Ü</button>
        </div>
        <input type="text" id="expSearch" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="search-box">
        <ul id="expList"></ul>
      </section>`;
    await renderList(root, 'expenses', '#expForm', '#expList', '#expSearch');
  },

  async incomes(root) {
    root.innerHTML = `
      <section>
        <h2>–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h2>
        <form id="incForm">
          <input name="amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required>
          <input name="date" type="date" required>
          <input name="source" placeholder="–ò—Å—Ç–æ—á–Ω–∏–∫" required>
          <select name="category">
            <option value="–ü–æ—Å–æ–±–∏–µ">–ü–æ—Å–æ–±–∏–µ</option>
            <option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option>
            <option value="–ü–æ–º–æ—â—å">–ü–æ–º–æ—â—å</option>
            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
            <option value="custom">–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è‚Ä¶</option>
          </select>
          <input name="custom" placeholder="–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" style="display:none">
          <select name="color">
            <option value="green">üü¢</option>
            <option value="yellow">üü°</option>
            <option value="red">üî¥</option>
          </select>
          <button>–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
      </section>
      <section>
        <div class="filter-bar">
          <button data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
          <button data-filter="week">–ù–µ–¥–µ–ª—è</button>
          <button data-filter="month">–ú–µ—Å—è—Ü</button>
        </div>
        <input type="text" id="incSearch" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="search-box">
        <ul id="incList"></ul>
      </section>`;
    await renderList(root, 'incomes', '#incForm', '#incList', '#incSearch');
  },

  work(root) {
    root.innerHTML = `
      <nav class="sub">
        <button data-sub="positions" class="active">–ü–æ–∑–∏—Ü–∏–∏</button>
        <button data-sub="log">–í—ã—Ä–∞–±–æ—Ç–∫–∞</button>
        <button data-sub="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </nav>
      <div id="workRoot"></div>`;
    const sub = root.querySelector('.sub');
    const wr = root.querySelector('#workRoot');
    sub.addEventListener('click', e => {
      if (!e.target.dataset.sub) return;
      [...sub.children].forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      ({ positions, log, stats }[e.target.dataset.sub])(wr);
    });
    positions(wr);
  }
};

/* ==========================================================
   10.  UTILITY HELPERS
========================================================== */
function rColor(str) {
  const h = str.split('').reduce((a, c) => a + c.charCodeAt(0), 0) % 3;
  return ['green', 'yellow', 'red'][h];
}
function drawBalanceChart(inc, exp) {
  const days = {};
  inc.forEach(r => days[r.date] = (days[r.date] || 0) + r.amount);
  exp.forEach(r => days[r.date] = (days[r.date] || 0) - r.amount);
  const sortedDays = Object.keys(days).sort();
  const running = sortedDays.reduce((a, d) => {
    a.push((a.at(-1) || 0) + days[d]);
    return a;
  }, []);
  bar(document.getElementById('balanceChart'), sortedDays, running);
}
function filterDate(records, type) {
  const now = new Date();
  return records.filter(r => {
    const d = new Date(r.date);
    if (type === 'today') return d.toDateString() === now.toDateString();
    if (type === 'week') {
      const weekAgo = new Date();
      weekAgo.setDate(now.getDate() - 7);
      return d >= weekAgo;
    }
    if (type === 'month') {
      const monthAgo = new Date();
      monthAgo.setMonth(now.getMonth() - 1);
      return d >= monthAgo;
    }
    return true;
  });
}
function drawHomeList(records) {
  const list = document.getElementById('homeList');
  const search = document.getElementById('searchInput');
  const buttons = document.querySelectorAll('#home .filter-bar button');
  const show = (recs = records) => {
    const term = search.value.toLowerCase();
    list.innerHTML = recs
      .filter(r => JSON.stringify(r).toLowerCase().includes(term))
      .map(r => `<li>${r.amount}‚ÇΩ ‚Äì ${r.target || r.source || ''} (${r.category}, ${r.date})
        <button onclick="del('${r.type}',${r.id}).then(()=>location.reload())">‚úñ</button></li>`)
      .join('');
  };
  search.addEventListener('input', () => show());
  buttons.forEach(btn =>
    btn.addEventListener('click', () => show(filterDate(records, btn.dataset.filter)))
  );
  show();
}
async function renderList(root, store, formSel, listSel, searchSel) {
  const form = root.querySelector(formSel);
  const list = root.querySelector(listSel);
  const search = root.querySelector(searchSel);
  const buttons = root.querySelectorAll('.filter-bar button');
  let records = await getAll(store);
  const show = (recs = records) => {
    const term = search.value.toLowerCase();
    list.innerHTML = recs
      .filter(r => JSON.stringify(r).toLowerCase().includes(term))
      .map(r => `<li>${r.amount}‚ÇΩ ‚Äì ${r.target || r.source || ''} (${r.category}, ${r.date})
        <button onclick="del('${store}',${r.id}).then(()=>location.reload())">‚úñ</button></li>`)
      .join('');
  };
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData(form);
    const obj = {
      amount: +fd.get('amount'),
      date: fd.get('date'),
      category: fd.get('category') === 'custom' ? fd.get('custom') : fd.get('category'),
      color: fd.get('color') || 'green'
    };
    if (store === 'expenses') obj.target = fd.get('target');
    else obj.source = fd.get('source');
    await add(store, obj);
    form.reset();
    records = await getAll(store);
    show();
  });
  search.addEventListener('input', () => show());
  buttons.forEach(btn =>
    btn.addEventListener('click', () => show(filterDate(records, btn.dataset.filter)))
  );
  show();
}

/* ==========================================================
   11.  WORK SUB-SECTIONS
========================================================== */
async function positions(root) {
  root.innerHTML = `
    <section>
      <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</h2>
      <form id="posForm">
        <input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
        <input name="holes" type="number" step="0.01" placeholder="–û—Ç–≤–µ—Ä—Å—Ç–∏–π –Ω–∞ 1–∫" required>
        <input name="sets"  type="number" step="0.01" placeholder="–ö–æ–º–ø–ª–µ–∫—Ç–æ–≤" required>
        <input name="price" type="number" step="0.01" placeholder="–¶–µ–Ω–∞ –∑–∞ 1 –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ (‚ÇΩ)" required>
        <button>–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
    </section>
    <section><h2>–ü–æ–∑–∏—Ü–∏–∏ (–ê-–Ø)</h2><ul id="posList"></ul></section>`;
  const form = root.querySelector('#posForm');
  const list = root.querySelector('#posList');
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const { name, holes, sets, price } = form.elements;
    await add('positions', {
      name: name.value.trim(),
      holes: +holes.value,
      sets: +sets.value,
      price: +price.value
    });
    form.reset();
    refresh();
  });
  async function refresh() {
    const items = await getAll('positions');
    items.sort((a, b) => a.name.localeCompare(b.name));
    list.innerHTML = items
      .map(p => `<li>${p.name} | ${p.holes} –æ—Ç–≤/1–∫ | ${p.sets} –∫–æ–º–ø–ª | ${p.price}‚ÇΩ/–æ—Ç–≤
        <button onclick="del('positions',${p.id}).then(refresh)">‚úñ</button></li>`)
      .join('');
  }
  refresh();
}
async function log(root) {
  const positions = await getAll('positions');
  root.innerHTML = `
    <section><h2>–ó–∞—Ä–∞–±–æ—Ç–æ–∫ ${new Date().getFullYear()}</h2><canvas id="bar"></canvas></section>
    <section>
      <h2>–î–æ–±–∞–≤–∏—Ç—å –≤—ã—Ä–∞–±–æ—Ç–∫—É</h2>
      <input type="date" id="date" required>
      <div id="addForm" style="display:none; flex-direction:column; gap:8px;">
        <select id="posSelect">${positions.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select>
        <input id="sets" type="number" step="0.01" placeholder="–ö–æ–º–ø–ª–µ–∫—Ç–æ–≤" min="0.01">
        <input id="price" type="number" step="0.01" placeholder="–¶–µ–Ω–∞ –∑–∞ 1 –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ (‚ÇΩ)" min="0.01">
        <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <ul id="dayList"></ul>
      <p id="dayTotal"></p>
    </section>`;
  const dateSel = root.querySelector('#date');
  const formDiv = root.querySelector('#addForm');
  const posSel = root.querySelector('#posSelect');
  const setsInp = root.querySelector('#sets');
  const priceInp = root.querySelector('#price');
  const saveBtn = root.querySelector('#saveBtn');
  const dayList = root.querySelector('#dayList');
  const dayTotal = root.querySelector('#dayTotal');
  dateSel.addEventListener('change', loadDay);
  saveBtn.addEventListener('click', async () => {
    const posId = +posSel.value;
    const sets = +setsInp.value;
    const price = +priceInp.value;
    if (!sets || !price) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞'); return; }
    const pos = positions.find(p => p.id === posId);
    const earned = (pos.holes * sets * price).toFixed(2);
    await add('worklog', { posId, sets, price, date: dateSel.value, earned: +earned });
    loadDay();
    refreshBar();
  });
  async function loadDay() {
    const d = dateSel.value;
    const logs = await getAll('worklog');
    const filtered = logs.filter(l => l.date === d);
    dayList.innerHTML = filtered
      .map(l => {
        const p = positions.find(p => p.id === l.posId);
        return `<li>${p.name} | ${p.holes * l.sets} –æ—Ç–≤ | ${l.sets} –∫–æ–º–ø–ª | ${l.price}‚ÇΩ/–æ—Ç–≤ | ${l.earned}‚ÇΩ –∏—Ç–æ–≥–æ
          <button onclick="del('worklog',${l.id}).then(loadDay)">‚úñ</button></li>`;
      })
      .join('');
    const totalEarned = filtered.reduce((a, b) => a + b.earned, 0).toFixed(2);
    const totalSets = filtered.reduce((a, b) => a + b.sets, 0);
    const totalHoles = filtered.reduce((a, b) => {
      const p = positions.find(p => p.id === b.posId);
      return a + p.holes * b.sets;
    }, 0);
    dayTotal.textContent = `–ò—Ç–æ–≥–æ: ${totalHoles} –æ—Ç–≤, ${totalSets} –∫–æ–º–ø–ª, ${totalEarned}‚ÇΩ`;
    formDiv.style.display = 'block';
  }
  async function refreshBar() {
    const logs = await getAll('worklog');
    const byMonth = Array(12).fill(0);
    logs.forEach(l => {
      const m = new Date(l.date).getMonth();
      byMonth[m] += l.earned;
    });
    bar(root.querySelector('#bar'), ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'], byMonth);
  }
  refreshBar();
}
async function stats(root) {
  const positions = await getAll('positions');
  root.innerHTML = `
    <section>
      <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h2>
      <label>–ú–µ—Å—è—Ü
        <select id="monthSel">${Array.from({ length: 12 }, (_, m) => `<option value="${m}">${new Date(0, m).toLocaleString('ru', { month: 'long' })}</option>`).join('')}</select>
      </label>
      <label>–ì–æ–¥
        <select id="yearSel">${Array.from({ length: 11 }, (_, i) => 2020 + i).map(y => `<option value="${y}" ${y === new Date().getFullYear() ? 'selected' : ''}>${y}</option>`).join('')}</select>
      </label>
      <ul id="statsList"></ul>
    </section>`;
  const monthSel = root.querySelector('#monthSel');
  const yearSel = root.querySelector('#yearSel');
  const list = root.querySelector('#statsList');
  [monthSel, yearSel].forEach(sel => sel.addEventListener('change', refresh));
  refresh();
  async function refresh() {
    const month = +monthSel.value;
    const year = +yearSel.value;
    const logs = await getAll('worklog');
    const filtered = logs.filter(l => {
      const d = new Date(l.date);
      return d.getMonth() === month && d.getFullYear() === year;
    });
    const map = new Map();
    filtered.forEach(l => {
      const name = positions.find(p => p.id === l.posId)?.name || '‚Äî';
      const cur = map.get(name) || { count: 0, sets: 0 };
      cur.count += 1;
      cur.sets += l.sets;
      map.set(name, cur);
    });
    list.innerHTML = [...map.entries()].map(([name, { count, sets }]) => `<li>${name} ‚Äì ${count} —Ä–∞–∑ ‚Äì ${sets} –∫–æ–º–ø–ª.</li>`).join('');
  }
}

/* ==========================================================
   12.  FIREBASE AUTH STATE LISTENER
========================================================== */
auth.onAuthStateChanged(async user => {
  currentUser = user;
  if (user) {
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('registerBtn').style.display = 'none';
    document.getElementById('userInfo').style.display = 'inline';
    await checkSubscription();
  } else {
    document.getElementById('loginBtn').style.display = 'inline';
    document.getElementById('registerBtn').style.display = 'inline';
    document.getElementById('userInfo').style.display = 'none';
  }
});

/* ==========================================================
   13.  INITIAL RENDER
========================================================== */
render('home');
</script>
<!-- üîê –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div id="authModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:#0005; z-index:9999">
  <div style="background:white; margin:10% auto; padding:20px; width:300px; border-radius:8px">
    <h3 id="authTitle">–í—Ö–æ–¥</h3>
    <input id="email" placeholder="Email" type="email"><br>
    <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password"><br>
    <input id="name" placeholder="–ò–º—è (–ø–æ –∂–µ–ª–∞–Ω–∏—é)" style="display:none"><br>
    <button onclick="submitAuth()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    <button onclick="closeAuth()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
</body>
</html>





