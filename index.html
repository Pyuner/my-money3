<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>Домашняя бухгалтерия</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
 :root{--accent:#007bff;--bg:#f7f7f7;--card:#fff;--text:#333;--border:#e0e0e0}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
body{background:var(--bg);color:var(--text)}
nav,.sub{display:flex;background:var(--card);border-bottom:1px solid var(--border)}
nav button,.sub button{flex:1;padding:14px;border:none;background:none;cursor:pointer;font-weight:600}
nav button.active,.sub button.active{color:var(--accent);border-bottom:2px solid var(--accent)}
main{padding:20px;max-width:800px;margin:auto}
section{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px;margin-bottom:20px}
form{display:grid;gap:12px}
input,select,button{padding:8px 10px;border:1px solid var(--border);border-radius:4px;font-size:1rem}
button[type=submit]{background:var(--accent);color:#fff;cursor:pointer}
ul{list-style:none}li{padding:6px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
canvas{width:100%!important;height:300px!important}
.actions button{margin-left:4px;background:none;border:1px solid var(--border);cursor:pointer;font-size:.8rem;padding:2px 6px;border-radius:3px}
</style>
</head>
<body>

<nav>
  <button data-tab="home" class="active">Главная</button>
  <button data-tab="expenses">Расходы</button>
  <button data-tab="incomes">Доходы</button>
  <button data-tab="work">Работа</button>
</nav>

<main id="content"></main>

<script type="module">
/* ===== IndexedDB ===== */
const DB_NAME='finance', DB_VER=2;
async function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB_NAME,DB_VER);
    r.onerror=()=>rej(r.error);
    r.onsuccess=()=>res(r.result);
    r.onupgradeneeded=()=>{
      const db=r.result;
      ['expenses','incomes','positions','worklog'].forEach(s=>{
        if(!db.objectStoreNames.contains(s)) db.createObjectStore(s,{keyPath:'id',autoIncrement:true});
      });
    };
  });
}
async function add(s,o){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite'),q=t.objectStore(s).add(o);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});}
async function put(s,o){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite'),q=t.objectStore(s).put(o);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});}
async function getAll(s){const db=await openDB();return new Promise((res,rej)=>{const q=db.transaction(s,'readonly').objectStore(s).getAll();q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error);});}
async function del(s,id){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite'),q=t.objectStore(s).delete(id);q.onsuccess=res;q.onerror=()=>rej(q.error);});}

/* ===== Chart.js ===== */
import Chart from 'https://cdn.jsdelivr.net/npm/chart.js@4/auto/+esm';
function pie(ctx,lbl,data){new Chart(ctx,{type:'pie',data:{labels:lbl,datasets:[{data,backgroundColor:['#28a745','#dc3545']}]},options:{responsive:true,maintainAspectRatio:false}});}
function bar(ctx,lbl,data){new Chart(ctx,{type:'bar',data:{labels:lbl,datasets:[{label:'₽',data,backgroundColor:'#007bff'}]},options:{responsive:true,maintainAspectRatio:false}});}

/* ===== Роутер ===== */
const nav=document.querySelector('nav'), content=document.getElementById('content');
nav.addEventListener('click',e=>{
  if(e.target.tagName!=='BUTTON') return;
  [...nav.children].forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  render(e.target.dataset.tab);
});
const sum=a=>a.reduce((s,x)=>s+x.amount,0);

/* ===== Вкладки ===== */
const tabs={
  /* Главная */
  async home(root){/* ===== Главная ===== */
async function home(root){
  const [inc, exp] = await Promise.all([getAll('incomes'), getAll('expenses')]);

  /* сводная по категориям */
  const incCats = {}, expCats = {};
  inc.forEach(r => incCats[r.category] = (incCats[r.category] || 0) + r.amount);
  exp.forEach(r => expCats[r.category] = (expCats[r.category] || 0) + r.amount);

  root.innerHTML = `
    <section>
      <h2>Доходы / Расходы</h2>
      <canvas id="pie"></canvas>
    </section>

    <!-- Доходы по категориям -->
    <section>
      <h2>Доходы по категориям</h2>
      <ul>
        ${Object.entries(incCats)
          .sort(([,a],[,b]) => b - a)
          .map(([cat, sum]) => `<li>${cat}: ${sum.toFixed(2)}₽</li>`)
          .join('')}
      </ul>
    </section>

    <!-- Расходы по категориям -->
    <section>
      <h2>Расходы по категориям</h2>
      <ul>
        ${Object.entries(expCats)
          .sort(([,a],[,b]) => b - a)
          .map(([cat, sum]) => `<li>${cat}: ${sum.toFixed(2)}₽</li>`)
          .join('')}
      </ul>
    </section>

    <!-- диаграммы по годам -->
    <section>
      <h2>Выберите год для подробных диаграмм</h2>
      <select id="yearSelect">
        ${Array.from({length:11},(_,i)=>2020+i).map(y=>`<option value="${y}" ${y===new Date().getFullYear()?'selected':''}>${y}</option>`).join('')}
      </select>
    </section>
    <section><h2>Доходы по месяцам (убывание)</h2><canvas id="incChart"></canvas></section>
    <section><h2>Расходы по месяцам (убывание)</h2><canvas id="expChart"></canvas></section>
    <section><h2>Зарплата по месяцам (убывание)</h2><canvas id="salChart"></canvas></section>
  `;

  const totalInc = Object.values(incCats).reduce((a,b)=>a+b,0);
  const totalExp = Object.values(expCats).reduce((a,b)=>a+b,0);
  pie(document.getElementById('pie'), ['Доходы','Расходы'], [totalInc, totalExp]);

  /* остальные диаграммы ... */
  const yearSel = root.querySelector('#yearSelect');
  yearSel.addEventListener('change', drawCharts);
  drawCharts();
  async function drawCharts(){
    const y = yearSel.value;
    const incByMonth = Array(12).fill(0);
    const expByMonth = Array(12).fill(0);
    const salByMonth = Array(12).fill(0);
    (await getAll('incomes')).forEach(r=>{
      const d=new Date(r.date); if(d.getFullYear()==y){incByMonth[d.getMonth()]+=r.amount; if(r.category==='Зарплата') salByMonth[d.getMonth()]+=r.amount;}
    });
    (await getAll('expenses')).forEach(r=>{const d=new Date(r.date); if(d.getFullYear()==y) expByMonth[d.getMonth()]+=r.amount;});
    const months=['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'];
    bar(root.querySelector('#incChart'),months,incByMonth);
    bar(root.querySelector('#expChart'),months,expByMonth);
    bar(root.querySelector('#salChart'),months,salByMonth);
  }
}
  },

  /* Расходы */
  async expenses(root){
    root.innerHTML=`
      <section>
        <h2>Добавить расход</h2>
        <form id="expForm">
          <input name="amount" type="number" placeholder="Сумма" required>
          <input name="date" type="date" required>
          <input name="target" placeholder="Куда потрачено" required>
          <select name="category">
            <option value="Супермаркеты">Супермаркеты</option><option value="Развлечения">Развлечения</option>
            <option value="Транспорт">Транспорт</option><option value="Такси">Такси</option>
            <option value="Маркетплейсы">Маркетплейсы</option><option value="Долги">Долги</option>
            <option value="custom">Своя категория…</option>
          </select>
          <input name="custom" placeholder="Своя категория" style="display:none">
          <button>Добавить</button>
        </form>
      </section>
      <section><h2>История</h2><ul id="expList"></ul></section>`;
    const form=root.querySelector('#expForm'), list=root.querySelector('#expList');
    form.category.addEventListener('change',e=>form.custom.style.display=e.target.value==='custom'?'block':'none');
    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const {amount,date,target,category,custom}=form.elements;
      await add('expenses',{amount:+amount.value,date:date.value,target:target.value,category:category.value==='custom'?custom.value:category.value});
      form.reset(); refresh();
    });
    async function refresh(){
      list.innerHTML=(await getAll('expenses')).map(e=>`<li>${e.amount}₽ – ${e.target} (${e.category}, ${e.date})<button onclick="del('expenses',${e.id}).then(refresh)">✖</button></li>`).join('');
    }
    refresh();
  },

  /* Доходы */
  async incomes(root){
    root.innerHTML=`
      <section>
        <h2>Добавить доход</h2>
        <form id="incForm">
          <input name="amount" type="number" placeholder="Сумма" required>
          <input name="date" type="date" required>
          <input name="source" placeholder="Источник" required>
          <select name="category"><option value="Пособие">Пособие</option><option value="Зарплата">Зарплата</option><option value="Помощь">Помощь</option><option value="Другое">Другое</option><option value="custom">Своя категория…</option></select>
          <input name="custom" placeholder="Своя категория" style="display:none">
          <button>Добавить</button>
        </form>
      </section>
      <section><h2>История</h2><ul id="incList"></ul></section>`;
    const form=root.querySelector('#incForm'), list=root.querySelector('#incList');
    form.category.addEventListener('change',e=>form.custom.style.display=e.target.value==='custom'?'block':'none');
    form.addEventListener('submit',async e=>{
      e.preventDefault();
      const {amount,date,source,category,custom}=form.elements;
      await add('incomes',{amount:+amount.value,date:date.value,source:source.value,category:category.value==='custom'?custom.value:category.value});
      form.reset(); refresh();
    });
    async function refresh(){
      list.innerHTML=(await getAll('incomes')).map(i=>`<li>${i.amount}₽ – ${i.source} (${i.category}, ${i.date})<button onclick="del('incomes',${i.id}).then(refresh)">✖</button></li>`).join('');
    }
    refresh();
  },

  /* Работа */
  work(root){
    root.innerHTML=`
      <nav class="sub">
        <button data-sub="positions" class="active">Позиции</button>
        <button data-sub="log">Выработка</button>
      </nav>
      <div id="workRoot"></div>`;
    const sub=root.querySelector('.sub'), wr=root.querySelector('#workRoot');
    sub.addEventListener('click',e=>{
      if(!e.target.dataset.sub) return;
      [...sub.children].forEach(b=>b.classList.remove('active'));
      e.target.classList.add('active');
      e.target.dataset.sub==='positions'?positions(wr):log(wr);
    });
    positions(wr);
  }
};

/* ===== Доп. функции для «Работа» ===== */
async function positions(root){
  root.innerHTML=`
    <section>
      <h2>Добавить позицию</h2>
      <form id="posForm">
        <input name="name" placeholder="Название" required>
        <input name="holes" type="number" step="0.01" placeholder="Отверстий на 1к" required>
        <input name="sets"  type="number" step="0.01" placeholder="Комплектов" required>
        <input name="price" type="number" step="0.01" placeholder="Цена за 1 отверстие (₽)" required>
        <button>Добавить</button>
      </form>
    </section>
    <section><h2>Позиции (А-Я)</h2><ul id="posList"></ul></section>`;
  const form=root.querySelector('#posForm'), list=root.querySelector('#posList');
  form.addEventListener('submit',async e=>{
    e.preventDefault();
    const {name,holes,sets,price}=form.elements;
    await add('positions',{name:name.value.trim(),holes:+holes.value,sets:+sets.value,price:+price.value});
    form.reset(); refresh();
  });
  async function refresh(){
    const items=await getAll('positions');
    items.sort((a,b)=>a.name.localeCompare(b.name));
    list.innerHTML=items.map(p=>`<li>${p.name} | ${p.holes} отв/1к | ${p.sets} компл | ${p.price}₽/отв <button onclick="del('positions',${p.id}).then(refresh)">✖</button></li>`).join('');
  }
  refresh();
}

async function log(root){
  const positions=await getAll('positions');
  root.innerHTML=`
    <section><h2>Заработок ${new Date().getFullYear()}</h2><canvas id="bar"></canvas></section>
    <section>
      <h2>Добавить выработку</h2>
      <input type="date" id="date" required>
      <div id="addForm" style="display:none; flex-direction:column; gap:8px;">
        <select id="posSelect">${positions.map(p=>`<option value="${p.id}">${p.name}</option>`)}</select>
        <input id="sets" type="number" step="0.01" placeholder="Комплектов" min="0.01">
        <input id="price" type="number" step="0.01" placeholder="Цена за 1 отверстие (₽)" min="0.01">
        <button id="saveBtn">Сохранить</button>
      </div>
      <ul id="dayList"></ul>
      <p id="dayTotal"></p>
    </section>`;
  const dateSel=root.querySelector('#date'), formDiv=root.querySelector('#addForm'), posSel=root.querySelector('#posSelect'), setsInp=root.querySelector('#sets'), priceInp=root.querySelector('#price'), saveBtn=root.querySelector('#saveBtn'), dayList=root.querySelector('#dayList'), dayTotal=root.querySelector('#dayTotal');
  dateSel.addEventListener('change',loadDay);
  saveBtn.addEventListener('click',async ()=>{
    const posId=+posSel.value, sets=+setsInp.value, price=+priceInp.value;
    if(!sets||!price){ alert('Введите корректные числа'); return; }
    const pos=positions.find(p=>p.id===posId);
    const earned=(pos.holes*sets*price).toFixed(2);
    await add('worklog',{posId,sets,price,date:dateSel.value,earned:+earned});
    loadDay(); refreshBar();
  });
  async function loadDay(){
    const d=dateSel.value;
    const logs=await getAll('worklog');
    const filtered=logs.filter(l=>l.date===d);
    dayList.innerHTML=filtered.map(l=>{
      const p=positions.find(p=>p.id===l.posId);
      return `<li>${p.name} | ${p.holes*l.sets} отв | ${l.sets} компл | ${l.price}₽/отв | ${l.earned}₽ итого <button onclick="del('worklog',${l.id}).then(loadDay)">✖</button></li>`;
    }).join('');
    const totalEarned=filtered.reduce((a,b)=>a+b.earned,0).toFixed(2);
    const totalSets=filtered.reduce((a,b)=>a+b.sets,0);
    const totalHoles=filtered.reduce((a,b)=>{const p=positions.find(p=>p.id===b.posId);return a+p.holes*b.sets;},0);
    dayTotal.textContent=`Итого: ${totalHoles} отв, ${totalSets} компл, ${totalEarned}₽`;
    formDiv.style.display='block';
  }
  async function refreshBar(){
    const logs=await getAll('worklog');
    const byMonth=Array(12).fill(0);
    logs.forEach(l=>{const m=new Date(l.date).getMonth();byMonth[m]+=l.earned});
    bar(root.querySelector('#bar'),['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'],byMonth);
  }
  refreshBar();
}

/* ===== Редактирование / удаление ===== */
window.remove=async (store,id)=>{if(confirm('Удалить?')){await del(store,id);render(document.querySelector('button.active').dataset.tab);}};

/* старт */
function render(tab){tabs[tab](content);}
render('home');
</script>
</body>
</html>

