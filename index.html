<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>–î–æ–º–∞—à–Ω—è—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
 :root{
   --accent:#007bff;
   --bg:#f7f7f7;
   --card:#fff;
   --text:#333;
   --border:#e0e0e0;
   --success:#28a745;
   --warning:#ffc107;
   --danger:#dc3545;
 }
 [data-theme="dark"]{
   --bg:#121212;
   --card:#1e1e1e;
   --text:#eee;
   --border:#444;
 }
 *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
 body{background:var(--bg);color:var(--text);transition:.2s}
 nav,.sub{display:flex;background:var(--card);border-bottom:1px solid var(--border)}
 nav button,.sub button{flex:1;padding:14px;border:none;background:none;cursor:pointer;font-weight:600}
 nav button.active,.sub button.active{color:var(--accent);border-bottom:2px solid var(--accent)}
 main{padding:20px;max-width:800px;margin:auto}
 section{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px;margin-bottom:20px}
 form{display:grid;gap:12px}
 input,select,button{padding:8px 10px;border:1px solid var(--border);border-radius:4px;font-size:1rem}
 button[type=submit]{background:var(--accent);color:#fff;cursor:pointer}
 ul{list-style:none}li{padding:6px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
 canvas{width:100%!important;height:300px!important}
 .filter-bar{display:flex;gap:8px;margin-bottom:10px}
 .filter-bar button{padding:4px 8px;font-size:.8rem;border:1px solid var(--border);border-radius:4px;background:#fff}
 [data-theme="dark"] .filter-bar button{background:#222}
 .search-box{margin-bottom:10px}
 .tag-red{background:var(--danger);color:#fff;padding:2px 6px;border-radius:4px;font-size:.7rem}
 .tag-yellow{background:var(--warning);color:#000;padding:2px 6px;border-radius:4px;font-size:.7rem}
 .tag-green{background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:.7rem}
 .theme-btn{margin-left:auto;background:none;border:none;font-size:1.2rem;cursor:pointer}
 .cloud-btn{margin-left:8px}
</style>
</head>
<body>

<nav>
  <button data-tab="home" class="active">–ì–ª–∞–≤–Ω–∞—è</button>
  <button data-tab="expenses">–†–∞—Å—Ö–æ–¥—ã</button>
  <button data-tab="incomes">–î–æ—Ö–æ–¥—ã</button>
  <button data-tab="work">–†–∞–±–æ—Ç–∞</button>
  <button class="theme-btn" id="themeToggle" title="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞">üåô</button>
  <button class="theme-btn cloud-btn" id="syncToggle" title="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è">‚òÅÔ∏è</button>
</nav>

<main id="content"></main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script type="module">
/* ===== 1.  Firebase Config (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô) ===== */
const firebaseConfig = {
"type": "service_account",
  "project_id": "my-money-4cb7e",
  "private_key_id": "e7242a0286d277ca51bd4810b6c65a9f357c5793",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCkTnT1P+JSL37y\nrS5nPhx2pzzZnYk5WqAgl5y2Z3cMJ5FxgsCiP7OrXaxL8ruMgcNz2yaOUm9iCnqm\ndqqu5ckymz1xMoO/VIqRmc3j0iqYw/04OFajCNatLzylOo5IHbI1XoPdyXpa+mxz\nZ/IAVD+yVJiwH/PLOnXGfMpHdjL2kLB6BnNtu3koCPxYTtNQcKrXD1PzY4Ikdkni\nZveHsDNqSnb2u3T+/DzhT2/RxPpK4FOigT0tUZOxFeaWq5EfKk49Dlzq4WwHhUBi\n4Tqyzv+fw+3B4XAnwqH1aMDFlg1Q8NSkfVQoy3G9RDpp5y19GY+8cA3ztrUdUPkK\nuS2Rb1ijAgMBAAECggEAAj/w5sUMQ/vjo3kXYs0dSUKAGSqVe+7LX6OsWI6kdMJi\nEuDrfIbZxQ0ovNUWIKtL7d04CG7Jh7bnN+TkiiSaM385idnSuFRS6ptDfwRTp3S1\nJwNI31cV4BhUDY3uAOHrvu1Dv04O1/BmNsHsX2gMLkwYLNyrJEc1i0zJzGbmKL5y\nWynqXRKYZSvWchImzTQysrj2XJMkbNkBe+ddkHdD7LE0MiDq5fw61zAtEH+EO3bD\n6yKXXJ+ZY2fOj8q1zjpbQUrLHmHmq2og5mon0UN04uMrn6mMMQcmpUn34iqFD+rY\n/vY9Fx4b8ZQyq2o8ul0r5XH+o+bXgkXgEh620YDfhQKBgQDSmFfqa4Bou0XJJSct\n3CQOtW6Ekog9GvyNqQ0jPrwV1C33HR0MzKuvdQzax/EbTXafbpKr9fmh/UMj7NyN\nlX8OMvz2O4bEaYuw77D5s/BjxJAhF4SaDoFXeVd2AAB+t4c4LTEKssbZUdYKz23O\ngkhzFJJ0XXI+yGrr2Sr/haOIFQKBgQDHuz5nN03ruA6rqUe/gOPCfGy93HKl991u\naBqBoXK+g9OJtiK/9QTmBoPqRKXp1gkamVOryl5XLzU4N7vJZ/DVp4TLHqBaRgE6\n7a5Wjqhc8I23X9PPl30LosHGDNYlSslsU8LpAGgyh+YfW5ssgQgFP6CQWE9WfYIF\nK0iW3yST1wKBgDdP1f92/sIDNeAPxwuPf1TxqDZfujK6bMzUMuQn7QSatvvphKDA\n/PLXfmnUC+qM3PQg+Zr6vvch6sl7w63YLwfOsowFtG7P/eWZ/tSGw0Og8+4NHEHO\nP4B3GVafx4GAuJ4zmGbj78BSczJhqsiLhXXcWF8B0CjXQOXzIwz7z6jFAoGAFAtN\nguxA7KQHDOErKyPTN6RnAVLLSq6qUTcvWc0LB+WQ6CQYLq13NWJ4AJ2tDN+HAF1c\n0UO43gUF0UN+nALLX5W1NPE45HZcDz7lHRip+tHFVx7N0eqBCRbnXWnSX+G2fyGU\n0O9Shaevx3vZAcldNbGh+npyU9q6nqwuV73DHPcCgYANUpD72+4917ZiVsqYeJH/\nvK6ydYlPUgToWWRFBEXUACzT9VlSuOJ/qnlPiYypW9U8MLlas6v01B0zamaB4FXF\nF0H5op7u6AAGhb01hwNUXgBsDNB7bnNWUc+M/3RWsk5lZSMf4pu2XU7fK8/5JA6l\nUyrQ0S5xhdy7D2HkC+sYTA==\n-----END PRIVATE KEY-----\n",
  "client_email": "firebase-adminsdk-fbsvc@my-money-4cb7e.iam.gserviceaccount.com",
  "client_id": "114027792495672776212",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-fbsvc%40my-money-4cb7e.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com""
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== 2.  IndexedDB ===== */
const DB_NAME='finance', DB_VER=2;
async function openDB(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open(DB_NAME,DB_VER);
    r.onerror=()=>rej(r.error);
    r.onsuccess=()=>res(r.result);
    r.onupgradeneeded=()=>{const db=r.result;['expenses','incomes','positions','worklog'].forEach(s=>{if(!db.objectStoreNames.contains(s))db.createObjectStore(s,{keyPath:'id',autoIncrement:true})})};
  });
}
async function add(s,o){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite'),q=t.objectStore(s).add(o);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error)})}
async function put(s,o){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite'),q=t.objectStore(s).put(o);q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error)})}
async function getAll(s){const db=await openDB();return new Promise((res,rej)=>{const q=db.transaction(s,'readonly').objectStore(s).getAll();q.onsuccess=()=>res(q.result);q.onerror=()=>rej(q.error)})}
async function del(s,id){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(s,'readwrite'),q=t.objectStore(s).delete(id);q.onsuccess=res;q.onerror=()=>rej(q.error)})}

/* ===== 3.  Chart.js ===== */
import Chart from 'https://cdn.jsdelivr.net/npm/chart.js@4/auto/+esm';
function pie(ctx,lbl,data){new Chart(ctx,{type:'pie',data:{labels:lbl,datasets:[{data,backgroundColor:['#28a745','#dc3545']}]},options:{responsive:true,maintainAspectRatio:false}})}
function bar(ctx,lbl,data){new Chart(ctx,{type:'bar',data:{labels:lbl,datasets:[{label:'‚ÇΩ',data,backgroundColor:'#007bff'}]},options:{responsive:true,maintainAspectRatio:false}})}

/* ===== 4.  –¢–µ–º–∞ ===== */
const themeToggle=document.getElementById('themeToggle');
themeToggle.addEventListener('click',()=>{
  const dark=document.documentElement.dataset.theme==='dark';
  document.documentElement.dataset.theme=dark?'light':'dark';
  themeToggle.textContent=dark?'üåô':'‚òÄÔ∏è';
  localStorage.setItem('theme',document.documentElement.dataset.theme);
});
document.documentElement.dataset.theme=localStorage.getItem('theme')||'light';
themeToggle.textContent=document.documentElement.dataset.theme==='dark'?'‚òÄÔ∏è':'üåô';

/* ===== 5.  –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ===== */
let syncEnabled=false;
const syncBtn=document.getElementById('syncToggle');
syncBtn.addEventListener('click',async()=>{
  syncEnabled=!syncEnabled;
  syncBtn.style.color=syncEnabled?'var(--accent)':'';
  if(!syncEnabled) return;
  ['expenses','incomes','positions','worklog'].forEach(async t=>{
    const local=await getAll(t);
    local.forEach(async r=>{
      await db.collection(t).doc(r.id.toString()).set(r);
    });
  });
  alert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ!');
});

/* ===== 6.  –†–æ—É—Ç–µ—Ä ===== */
const nav=document.querySelector('nav'), content=document.getElementById('content');
nav.addEventListener('click',e=>{
  if(!e.target.dataset.tab) return;
  [...nav.children].forEach(b=>b.classList.remove('active'));
  e.target.classList.add('active');
  render(e.target.dataset.tab);
});
const sum=a=>a.reduce((s,x)=>s+x.amount,0);

/* ===== 7.  –í–∫–ª–∞–¥–∫–∏ ===== */
const tabs={

  /* –ì–ª–∞–≤–Ω–∞—è */
  async home(root){
    const [inc,exp]=await Promise.all([getAll('incomes'),getAll('expenses')]);
    const incCats={},expCats={};
    inc.forEach(r=>incCats[r.category]=(incCats[r.category]||0)+r.amount);
    exp.forEach(r=>expCats[r.category]=(expCats[r.category]||0)+r.amount);

    root.innerHTML=`
      <section><h2>–î–æ—Ö–æ–¥—ã / –†–∞—Å—Ö–æ–¥—ã</h2><canvas id="pie"></canvas></section>
      <section><h2>–î–æ—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2><ul>${Object.entries(incCats).sort(([,a],[,b])=>b-a).map(([c,s])=>`<li><span class="tag-${rColor(c)}"></span>${c}: ${s.toFixed(2)}‚ÇΩ</li>`).join('')}</ul></section>
      <section><h2>–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2><ul>${Object.entries(expCats).sort(([,a],[,b])=>b-a).map(([c,s])=>`<li><span class="tag-${rColor(c)}"></span>${c}: ${s.toFixed(2)}‚ÇΩ</li>`).join('')}</ul></section>

      <section>
        <h2>–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è –ø–æ –¥–Ω—è–º</h2>
        <canvas id="balanceChart"></canvas>
      </section>

      <section>
        <h2>–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ</h2>
        <div class="filter-bar">
          <button data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
          <button data-filter="week">–ù–µ–¥–µ–ª—è</button>
          <button data-filter="month">–ú–µ—Å—è—Ü</button>
        </div>
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="search-box">
        <ul id="homeList"></ul>
      </section>`;

    const totalInc=Object.values(incCats).reduce((a,b)=>a+b,0);
    const totalExp=Object.values(expCats).reduce((a,b)=>a+b,0);
    pie(document.getElementById('pie'),['–î–æ—Ö–æ–¥—ã','–†–∞—Å—Ö–æ–¥—ã'],[totalInc,totalExp]);
    drawBalanceChart(inc,exp);
    drawHomeList(inc.concat(exp.map(e=>({...e,type:'exp'}))));
  },

  /* –†–∞—Å—Ö–æ–¥—ã */
  async expenses(root){
    root.innerHTML=`
      <section>
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h2>
        <form id="expForm">
          <input name="amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required>
          <input name="date" type="date" required>
          <input name="target" placeholder="–ö—É–¥–∞ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ" required>
          <select name="category">
            <option value="–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã">–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã</option><option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
            <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option><option value="–¢–∞–∫—Å–∏">–¢–∞–∫—Å–∏</option>
            <option value="–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã</option><option value="–î–æ–ª–≥–∏">–î–æ–ª–≥–∏</option>
            <option value="custom">–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è‚Ä¶</option>
          </select>
          <input name="custom" placeholder="–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" style="display:none">
          <select name="color">
            <option value="green">üü¢</option><option value="yellow">üü°</option><option value="red">üî¥</option>
          </select>
          <button>–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
      </section>
      <section>
        <div class="filter-bar">
          <button data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
          <button data-filter="week">–ù–µ–¥–µ–ª—è</button>
          <button data-filter="month">–ú–µ—Å—è—Ü</button>
        </div>
        <input type="text" id="expSearch" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="search-box">
        <ul id="expList"></ul>
      </section>`;
    await renderList(root,'expenses','#expForm','#expList','#expSearch');
  },

  /* –î–æ—Ö–æ–¥—ã */
  async incomes(root){
    root.innerHTML=`
      <section>
        <h2>–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h2>
        <form id="incForm">
          <input name="amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required>
          <input name="date" type="date" required>
          <input name="source" placeholder="–ò—Å—Ç–æ—á–Ω–∏–∫" required>
          <select name="category"><option value="–ü–æ—Å–æ–±–∏–µ">–ü–æ—Å–æ–±–∏–µ</option><option value="–ó–∞—Ä–ø–ª–∞—Ç–∞">–ó–∞—Ä–ø–ª–∞—Ç–∞</option><option value="–ü–æ–º–æ—â—å">–ü–æ–º–æ—â—å</option><option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option><option value="custom">–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è‚Ä¶</option></select>
          <input name="custom" placeholder="–°–≤–æ—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è" style="display:none">
          <select name="color">
            <option value="green">üü¢</option><option value="yellow">üü°</option><option value="red">üî¥</option>
          </select>
          <button>–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
      </section>
      <section>
        <div class="filter-bar">
          <button data-filter="today">–°–µ–≥–æ–¥–Ω—è</button>
          <button data-filter="week">–ù–µ–¥–µ–ª—è</button>
          <button data-filter="month">–ú–µ—Å—è—Ü</button>
        </div>
        <input type="text" id="incSearch" placeholder="–ü–æ–∏—Å–∫‚Ä¶" class="search-box">
        <ul id="incList"></ul>
      </section>`;
    await renderList(root,'incomes','#incForm','#incList','#incSearch');
  },

  /* –†–∞–±–æ—Ç–∞ */
  work(root){
    root.innerHTML=`
      <nav class="sub">
        <button data-sub="positions" class="active">–ü–æ–∑–∏—Ü–∏–∏</button>
        <button data-sub="log">–í—ã—Ä–∞–±–æ—Ç–∫–∞</button>
        <button data-sub="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      </nav>
      <div id="workRoot"></div>`;
    const sub=root.querySelector('.sub'), wr=root.querySelector('#workRoot');
    sub.addEventListener('click',e=>{if(!e.target.dataset.sub) return; [...sub.children].forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); ({positions,log,stats}[e.target.dataset.sub])(wr);});
    positions(wr);
  }
};

/* ===== –û–±—â–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ===== */
function rColor(str){const h=str.split('').reduce((a,c)=>a+c.charCodeAt(0),0)%3; return ['green','yellow','red'][h];}
function drawBalanceChart(inc,exp){
  const days={};
  inc.forEach(r=>{const d=r.date; days[d]=(days[d]||0)+r.amount});
  exp.forEach(r=>{const d=r.date; days[d]=(days[d]||0)-r.amount});
  const sortedDays=Object.keys(days).sort();
  const running=sortedDays.reduce((a,d)=>{a.push((a.at(-1)||0)+days[d]); return a;},[]);
  bar(document.getElementById('balanceChart'),sortedDays,running);
}
function filterDate(records,type){   // today / week / month
  const now=new Date();
  return records.filter(r=>{
    const d=new Date(r.date);
    if(type==='today') return d.toDateString()===now.toDateString();
    if(type==='week'){const weekAgo=new Date();weekAgo.setDate(now.getDate()-7);return d>=weekAgo;}
    if(type==='month'){const monthAgo=new Date();monthAgo.setMonth(now.getMonth()-1);return d>=monthAgo;}
    return true;
  });
}
function renderSearch(listEl,records,search){   // live search
  const term=search.toLowerCase();
  listEl.innerHTML=records.filter(r=>JSON.stringify(r).toLowerCase().includes(term))
    .map(r=>`<li>${r.amount}‚ÇΩ ‚Äì ${r.target||r.source||''} (${r.category}, ${r.date})<button onclick="del('${r.type||'expenses'}',${r.id}).then(()=>location.reload())">‚úñ</button></li>`).join('');
}
async function renderList(root,store,formSel,listSel,searchSel){
  const form=root.querySelector(formSel),list=root.querySelector(listSel),search=root.querySelector(searchSel);
  const records=await getAll(store);
  const show=(recs=records)=>{renderSearch(list,recs.map(r=>({...r,type:store})),search.value);}
  form.addEventListener('submit',async e=>{
    e.preventDefault();
    const fd=new FormData(form);
    const obj={amount:+fd.get('amount'),date:fd.get('date'),category:fd.get('category')==='custom'?fd.get('custom'):fd.get('category'),color:fd.get('color')||'green'};
    if(store==='expenses') obj.target=fd.get('target'); else obj.source=fd.get('source');
    await add(store,obj);
    form.reset(); show();
  });
  search.addEventListener('input',()=>show(filterDate(records,'all')));
  root.querySelectorAll('.filter-bar button').forEach(btn=>btn.addEventListener('click',()=>show(filterDate(records,btn.dataset.filter))));
  show();
}

/* ===== –î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏ –†–∞–±–æ—Ç–∞ ===== */
async function positions(root){
  root.innerHTML=`
    <section>
      <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</h2>
      <form id="posForm">
        <input name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
        <input name="holes" type="number" step="0.01" placeholder="–û—Ç–≤–µ—Ä—Å—Ç–∏–π –Ω–∞ 1–∫" required>
        <input name="sets"  type="number" step="0.01" placeholder="–ö–æ–º–ø–ª–µ–∫—Ç–æ–≤" required>
        <input name="price" type="number" step="0.01" placeholder="–¶–µ–Ω–∞ –∑–∞ 1 –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ (‚ÇΩ)" required>
        <button>–î–æ–±–∞–≤–∏—Ç—å</button>
      </form>
    </section>
    <section><h2>–ü–æ–∑–∏—Ü–∏–∏ (–ê-–Ø)</h2><ul id="posList"></ul></section>`;
  const form=root.querySelector('#posForm'), list=root.querySelector('#posList');
  form.addEventListener('submit',async e=>{
    e.preventDefault();
    const {name,holes,sets,price}=form.elements;
    await add('positions',{name:name.value.trim(),holes:+holes.value,sets:+sets.value,price:+price.value});
    form.reset(); refresh();
  });
  async function refresh(){
    const items=await getAll('positions');
    items.sort((a,b)=>a.name.localeCompare(b.name));
    list.innerHTML=items.map(p=>`<li>${p.name} | ${p.holes} –æ—Ç–≤/1–∫ | ${p.sets} –∫–æ–º–ø–ª | ${p.price}‚ÇΩ/–æ—Ç–≤ <button onclick="del('positions',${p.id}).then(refresh)">‚úñ</button></li>`).join('');
  }
  refresh();
}

async function log(root){
  const positions=await getAll('positions');
  root.innerHTML=`
    <section><h2>–ó–∞—Ä–∞–±–æ—Ç–æ–∫ ${new Date().getFullYear()}</h2><canvas id="bar"></canvas></section>
    <section>
      <h2>–î–æ–±–∞–≤–∏—Ç—å –≤—ã—Ä–∞–±–æ—Ç–∫—É</h2>
      <input type="date" id="date" required>
      <div id="addForm" style="display:none; flex-direction:column; gap:8px;">
        <select id="posSelect">${positions.map(p=>`<option value="${p.id}">${p.name}</option>`)}</select>
        <input id="sets" type="number" step="0.01" placeholder="–ö–æ–º–ø–ª–µ–∫—Ç–æ–≤" min="0.01">
        <input id="price" type="number" step="0.01" placeholder="–¶–µ–Ω–∞ –∑–∞ 1 –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ (‚ÇΩ)" min="0.01">
        <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
      <ul id="dayList"></ul>
      <p id="dayTotal"></p>
    </section>`;
  const dateSel=root.querySelector('#date'), formDiv=root.querySelector('#addForm'), posSel=root.querySelector('#posSelect'), setsInp=root.querySelector('#sets'), priceInp=root.querySelector('#price'), saveBtn=root.querySelector('#saveBtn'), dayList=root.querySelector('#dayList'), dayTotal=root.querySelector('#dayTotal');
  dateSel.addEventListener('change',loadDay);
  saveBtn.addEventListener('click',async ()=>{
    const posId=+posSel.value, sets=+setsInp.value, price=+priceInp.value;
    if(!sets||!price){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —á–∏—Å–ª–∞'); return; }
    const pos=positions.find(p=>p.id===posId);
    const earned=(pos.holes*sets*price).toFixed(2);
    await add('worklog',{posId,sets,price,date:dateSel.value,earned:+earned});
    loadDay(); refreshBar();
  });
  async function loadDay(){
    const d=dateSel.value;
    const logs=await getAll('worklog');
    const filtered=logs.filter(l=>l.date===d);
    dayList.innerHTML=filtered.map(l=>{
      const p=positions.find(p=>p.id===l.posId);
      return `<li>${p.name} | ${p.holes*l.sets} –æ—Ç–≤ | ${l.sets} –∫–æ–º–ø–ª | ${l.price}‚ÇΩ/–æ—Ç–≤ | ${l.earned}‚ÇΩ –∏—Ç–æ–≥–æ <button onclick="del('worklog',${l.id}).then(loadDay)">‚úñ</button></li>`;
    }).join('');
    const totalEarned=filtered.reduce((a,b)=>a+b.earned,0).toFixed(2);
    const totalSets=filtered.reduce((a,b)=>a+b.sets,0);
    const totalHoles=filtered.reduce((a,b)=>{const p=positions.find(p=>p.id===b.posId);return a+p.holes*b.sets;},0);
    dayTotal.textContent=`–ò—Ç–æ–≥–æ: ${totalHoles} –æ—Ç–≤, ${totalSets} –∫–æ–º–ø–ª, ${totalEarned}‚ÇΩ`;
    formDiv.style.display='block';
  }
  async function refreshBar(){
    const logs=await getAll('worklog');
    const byMonth=Array(12).fill(0);
    logs.forEach(l=>{const m=new Date(l.date).getMonth();byMonth[m]+=l.earned});
    bar(root.querySelector('#bar'),['–Ø–Ω–≤','–§–µ–≤','–ú–∞—Ä','–ê–ø—Ä','–ú–∞–π','–ò—é–Ω','–ò—é–ª','–ê–≤–≥','–°–µ–Ω','–û–∫—Ç','–ù–æ—è','–î–µ–∫'],byMonth);
  }
  refreshBar();
}

async function stats(root){
  const positions=await getAll('positions');
  root.innerHTML=`
    <section>
      <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü</h2>
      <label>–ú–µ—Å—è—Ü
        <select id="monthSel">
          ${Array.from({length:12},(_,m)=>`<option value="${m}">${new Date(0,m).toLocaleString('ru',{month:'long'})}</option>`).join('')}
        </select>
      </label>
      <label>–ì–æ–¥
        <select id="yearSel">
          ${Array.from({length:11},(_,i)=>2020+i).map(y=>`<option value="${y}" ${y===new Date().getFullYear()?'selected':''}>${y}</option>`).join('')}
        </select>
      </label>
      <ul id="statsList"></ul>
    </section>`;
  const monthSel=root.querySelector('#monthSel'), yearSel=root.querySelector('#yearSel'), list=root.querySelector('#statsList');
  [monthSel,yearSel].forEach(sel=>sel.addEventListener('change',refresh));
  refresh();
  async function refresh(){
    const month=+monthSel.value, year=+yearSel.value;
    const logs=await getAll('worklog'), positions=await getAll('positions');
    const filtered=logs.filter(l=>{const d=new Date(l.date); return d.getMonth()===month && d.getFullYear()===year});
    const map=new Map();
    filtered.forEach(l=>{
      const name=positions.find(p=>p.id===l.posId)?.name || '‚Äî';
      const cur=map.get(name)||{count:0,sets:0};
      cur.count+=1;
      cur.sets+=l.sets;
      map.set(name,cur);
    });
    list.innerHTML=[...map.entries()].map(([name,{count,sets}])=>`<li>${name} ‚Äì ${count} —Ä–∞–∑ ‚Äì ${sets} –∫–æ–º–ø–ª.</li>`).join('');
  }
}

/* ===== 8.  –ó–∞–ø—É—Å–∫ ===== */
function render(tab){tabs[tab](content);}
render('home');
</script>
</body>
</html>
